{% extends "base.html" %}

{% block title %}Atlas Manager{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body text-center">
                    <h1 class="display-4 mb-4">Welcome to Atlas Manager</h1>
                    <p class="lead">IoT Device Management Platform based on DDL (Device Description Language)</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">What is Atlas Manager?</h4>
                </div>
                <div class="card-body">
                    <p>Atlas Manager is a platform that enables real-time monitoring and management of IoT devices. It uses DDL to describe and understand the capabilities of connected devices.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Available Sections</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-microchip"></i> Things</h5>
                                    <p class="card-text">View all IoT devices connected to the network. Here you can see detailed information about each device, including its model, manufacturer, and status.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-cogs"></i> Services</h5>
                                    <p class="card-text">Explore the services available on each device. This section shows the capabilities and functionalities that each device can offer.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-project-diagram"></i> Relationships</h5>
                                    <p class="card-text">Discover how devices and services relate to each other. This section shows the connections and dependencies between different system components.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title"><i class="fas fa-th-large"></i> Apps</h5>
                                    <p class="card-text">Manage available applications for interacting with devices. Here you can view, create, and modify applications that use device services.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <h4 class="mb-0">Getting Started</h4>
                </div>
                <div class="card-body">
                    <ol class="mb-0">
                        <li class="mb-2">Explore the <strong>Things</strong> section to view connected devices.</li>
                        <li class="mb-2">Check <strong>Services</strong> to understand what each device can do.</li>
                        <li class="mb-2">Consult <strong>Relationships</strong> to see how devices connect.</li>
                        <li class="mb-2">Visit <strong>Apps</strong> to interact with devices.</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Function to update things list
    function updateThingsList(things) {
        console.log('Updating things list with:', things);
        const thingsList = document.getElementById('thingsList');
        if (!thingsList) {
            console.error('Things list element not found');
            return;
        }
        
        thingsList.innerHTML = '';
        if (!things || things.length === 0) {
            thingsList.innerHTML = '<p>No things discovered yet.</p>';
            return;
        }

        things.forEach(thing => {
            const thingElement = document.createElement('div');
            thingElement.className = 'card mb-3';
            thingElement.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${thing.name || 'Unnamed Thing'}</h5>
                    <p class="card-text">
                        <strong>ID:</strong> ${thing.id}<br>
                        <strong>Model:</strong> ${thing.model || 'N/A'}<br>
                        <strong>Vendor:</strong> ${thing.vendor || 'N/A'}<br>
                        <strong>Owner:</strong> ${thing.owner || 'N/A'}<br>
                        <strong>Description:</strong> ${thing.description || 'N/A'}<br>
                        <strong>OS:</strong> ${thing.os || 'N/A'}<br>
                        <strong>Space ID:</strong> ${thing.space_id || 'N/A'}
                    </p>
                </div>
            `;
            thingsList.appendChild(thingElement);
        });
    }

    // Function to update services list
    function updateServicesList(services) {
        console.log('Updating services list with:', services);
        const servicesList = document.getElementById('servicesList');
        if (!servicesList) {
            console.error('Services list element not found');
            return;
        }
        
        servicesList.innerHTML = '';
        if (!services || services.length === 0) {
            servicesList.innerHTML = '<p>No services discovered yet.</p>';
            return;
        }

        services.forEach(service => {
            const serviceElement = document.createElement('div');
            serviceElement.className = 'card mb-3';
            serviceElement.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${service.name || service.id || 'Unnamed Service'}</h5>
                    <p class="card-text">
                        <strong>ID:</strong> ${service.id}<br>
                        <strong>API:</strong> ${service.api || 'N/A'}<br>
                        <strong>Type:</strong> ${service.type || 'N/A'}<br>
                        <strong>App Category:</strong> ${service.app_category || 'N/A'}<br>
                        <strong>Description:</strong> ${service.description || 'N/A'}<br>
                        <strong>Keywords:</strong> ${service.keywords || 'N/A'}<br>
                        <strong>Thing ID:</strong> ${service.thing_id || 'N/A'}<br>
                        <strong>Space ID:</strong> ${service.space_id || 'N/A'}
                    </p>
                </div>
            `;
            servicesList.appendChild(serviceElement);
        });
    }

    // Function to update relationships list
    function updateRelationshipsList(relationships) {
        console.log('Updating relationships list with:', relationships);
        const relationshipsList = document.getElementById('relationshipsList');
        if (!relationshipsList) {
            console.error('Relationships list element not found');
            return;
        }
        
        relationshipsList.innerHTML = '';
        if (!relationships || relationships.length === 0) {
            relationshipsList.innerHTML = '<p>No relationships discovered yet.</p>';
            return;
        }

        relationships.forEach(relationship => {
            const relationshipElement = document.createElement('div');
            relationshipElement.className = 'card mb-3';
            relationshipElement.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Relationship: ${relationship.id || 'Unnamed Relationship'}</h5>
                    <p class="card-text">
                        <strong>Source Service:</strong> ${relationship.source_service || 'N/A'}<br>
                        <strong>Target Service:</strong> ${relationship.target_service || 'N/A'}<br>
                        <strong>Type:</strong> ${relationship.type || 'N/A'}<br>
                        <strong>Description:</strong> ${relationship.description || 'N/A'}
                    </p>
                </div>
            `;
            relationshipsList.appendChild(relationshipElement);
        });
    }

    // Function to update space info
    function updateSpaceInfo(space) {
        console.log('Updating space info with:', space);
        const spaceInfo = document.getElementById('spaceInfo');
        if (!spaceInfo) {
            console.error('Space info element not found');
            return;
        }
        
        spaceInfo.innerHTML = '';
        if (!space || Object.keys(space).length === 0) {
            spaceInfo.innerHTML = '<p>No space information available.</p>';
            return;
        }

        Object.entries(space).forEach(([thingId, info]) => {
            const spaceElement = document.createElement('div');
            spaceElement.className = 'card mb-3';
            spaceElement.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">Space Info for Thing: ${thingId}</h5>
                    <p class="card-text">
                        <strong>Network Name:</strong> ${info.network_name || 'N/A'}<br>
                        <strong>Communication Language:</strong> ${info.communication_language || 'N/A'}<br>
                        <strong>IP:</strong> ${info.ip || 'N/A'}<br>
                        <strong>Port:</strong> ${info.port || 'N/A'}
                    </p>
                </div>
            `;
            spaceInfo.appendChild(spaceElement);
        });
    }

    // Socket.IO configuration
    const socket = io({
        transports: ['websocket', 'polling'],
        reconnection: true,
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        timeout: 20000
    });

    // Socket.IO event handlers
    socket.on('connect', () => {
        console.log('Connected to server');
        document.getElementById('connection-status').textContent = 'Connected';
        document.getElementById('connection-status').className = 'connected';
    });

    socket.on('disconnect', () => {
        console.log('Disconnected from server');
        document.getElementById('connection-status').textContent = 'Disconnected';
        document.getElementById('connection-status').className = 'disconnected';
    });

    socket.on('connect_error', (error) => {
        console.error('Connection error:', error);
        document.getElementById('connection-status').textContent = 'Connection Error';
        document.getElementById('connection-status').className = 'disconnected';
    });

    socket.on('reconnect', (attemptNumber) => {
        console.log('Reconnected after', attemptNumber, 'attempts');
        document.getElementById('connection-status').textContent = 'Connected';
        document.getElementById('connection-status').className = 'connected';
    });

    socket.on('reconnect_error', (error) => {
        console.error('Reconnection error:', error);
        document.getElementById('connection-status').textContent = 'Reconnection Error';
        document.getElementById('connection-status').className = 'disconnected';
    });

    socket.on('reconnect_failed', () => {
        console.error('Failed to reconnect');
        document.getElementById('connection-status').textContent = 'Connection Failed';
        document.getElementById('connection-status').className = 'disconnected';
    });

    socket.on('things_update', function(data) {
        console.log('Received things update:', data);
        if (Array.isArray(data)) {
            updateThingsList(data);
        }
    });

    socket.on('services_update', function(data) {
        console.log('Received services update:', data);
        if (Array.isArray(data)) {
            updateServicesList(data);
        }
    });

    socket.on('relationships_update', function(data) {
        console.log('Received relationships update:', data);
        if (Array.isArray(data)) {
            updateRelationshipsList(data);
        }
    });

    socket.on('space_update', function(data) {
        console.log('Received space update:', data);
        if (typeof data === 'object') {
            updateSpaceInfo(data);
        }
    });

    // Initial data load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Loading initial data...');
        
        fetch('/api/things')
            .then(response => response.json())
            .then(data => {
                console.log('Initial things data:', data);
                updateThingsList(data);
            })
            .catch(error => console.error('Error loading things:', error));

        fetch('/api/services')
            .then(response => response.json())
            .then(data => {
                console.log('Initial services data:', data);
                updateServicesList(data);
            })
            .catch(error => console.error('Error loading services:', error));

        fetch('/api/relationships')
            .then(response => response.json())
            .then(data => {
                console.log('Initial relationships data:', data);
                updateRelationshipsList(data);
            })
            .catch(error => console.error('Error loading relationships:', error));

        fetch('/api/space')
            .then(response => response.json())
            .then(data => {
                console.log('Initial space data:', data);
                updateSpaceInfo(data);
            })
            .catch(error => console.error('Error loading space info:', error));
    });

    // App management functions
    function uploadApp() {
        alert('App upload functionality to be implemented');
    }

    function newApp() {
        alert('New app creation functionality to be implemented');
    }
</script>
{% endblock %} 